#!/usr/bin/env python

import bdkd.datastore
import json, optparse

def main():
    usage = "usage: %prog [options] 'repository'"
    epilog = ("Get a list of all Resources in a Repository (or optionally "
            "those Resources underneath a leading path).")
    optparser = optparse.OptionParser(usage=usage, epilog=epilog)
    optparser.add_option('-p', '--path',
            help='Pseudopath in which to search (default all)')
    optparser.add_option('-v', '--verbose', action='store_true',
            help='Verbose mode: all resource details (default names only)')
    (options, args) = optparser.parse_args()

    if len(args) < 1:
        optparser.error("Need to provide a repository")

    # Repository
    repository_name = args.pop(0)
    repository = bdkd.datastore.repository(repository_name)
    if not repository:
        optparser.error("The repository '{0}' is not valid or not configured"
                .format(repository_name))

    resource_names = repository.list(options.path or '')
    for resource_name in resource_names:
        print(resource_name)
        if options.verbose:
            resource = repository.get(resource_name)
            print(resource.to_json(indent=4, separators=(',', ': ')) + "\n")

if __name__ == "__main__":
    main()
